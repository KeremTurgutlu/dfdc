---

title: Title

keywords: fastai
sidebar: home_sidebar

summary: "summary"
description: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/003 - save_face_crops.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Crop-faces-from-videos-by-detections-by-face_detections_df">Crop faces from videos by detections by <code>face_detections_df</code><a class="anchor-link" href="#Crop-faces-from-videos-by-detections-by-face_detections_df"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/ubuntu/data/&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">video_path</span> <span class="o">=</span> <span class="n">data_path</span><span class="o">/</span><span class="s2">&quot;dfdc_train_part_49&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metadata</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="s2">&quot;/home/ubuntu/data/dfdc_train_part_49/&quot;</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.json&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">video_files</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="s2">&quot;/home/ubuntu/data/dfdc_train_part_49/&quot;</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.mp4&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">read_metadata</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">metadf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">metadf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;split&#39;</span><span class="p">,</span><span class="s1">&#39;original&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">metadf</span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metadf</span> <span class="o">=</span> <span class="n">read_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metadf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fname</th>
      <th>label</th>
      <th>split</th>
      <th>original</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>dwwytkheyx.mp4</td>
      <td>FAKE</td>
      <td>train</td>
      <td>nlcqykqsdp.mp4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>bdsxxaamze.mp4</td>
      <td>FAKE</td>
      <td>train</td>
      <td>xzmplldajk.mp4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>tfceaqvefa.mp4</td>
      <td>FAKE</td>
      <td>train</td>
      <td>zkksmnscsf.mp4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lurozpmsqd.mp4</td>
      <td>FAKE</td>
      <td>train</td>
      <td>urbulrzowx.mp4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>jvlvkijuwa.mp4</td>
      <td>FAKE</td>
      <td>train</td>
      <td>wvnjcwevzo.mp4</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metadf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)[[</span><span class="s2">&quot;fname&quot;</span><span class="p">,</span><span class="s1">&#39;original&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fname</th>
      <th>original</th>
    </tr>
    <tr>
      <th>label</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>FAKE</th>
      <td>2619</td>
      <td>2619</td>
    </tr>
    <tr>
      <th>REAL</th>
      <td>515</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="face-detections">face detections<a class="anchor-link" href="#face-detections"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">face_detections_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;dfdc_faces/part_49_retina_detections.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">face_detections_df</span><span class="o">.</span><span class="n">face_detections</span> <span class="o">=</span> <span class="p">(</span><span class="n">face_detections_df</span><span class="o">.</span><span class="n">face_detections</span>
                                          <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">face_detections_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fname</th>
      <th>size</th>
      <th>face_detections</th>
      <th>n_frames</th>
      <th>sample_freq</th>
      <th>len_video</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>yraysfvtgv.mp4</td>
      <td>(1280, 720)</td>
      <td>[{'frame_no': 0, 'detections': [[290, 268, 398...</td>
      <td>31</td>
      <td>10</td>
      <td>301</td>
    </tr>
    <tr>
      <th>1</th>
      <td>jidkzoagws.mp4</td>
      <td>(1080, 1920)</td>
      <td>[{'frame_no': 0, 'detections': [[895, 172, 101...</td>
      <td>30</td>
      <td>10</td>
      <td>300</td>
    </tr>
    <tr>
      <th>2</th>
      <td>uowiocuqqt.mp4</td>
      <td>(1080, 1920)</td>
      <td>[{'frame_no': 0, 'detections': [[845, 265, 105...</td>
      <td>30</td>
      <td>10</td>
      <td>300</td>
    </tr>
    <tr>
      <th>3</th>
      <td>sigtxuuutc.mp4</td>
      <td>(1080, 1920)</td>
      <td>[{'frame_no': 0, 'detections': [[899, 139, 104...</td>
      <td>30</td>
      <td>10</td>
      <td>300</td>
    </tr>
    <tr>
      <th>4</th>
      <td>uzawooqxrq.mp4</td>
      <td>(1080, 1920)</td>
      <td>[{'frame_no': 0, 'detections': [[818, 146, 978...</td>
      <td>30</td>
      <td>10</td>
      <td>300</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Counter</span><span class="p">(</span><span class="n">face_detections_df</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Counter({&#39;(1280, 720)&#39;: 715, &#39;(1080, 1920)&#39;: 2234, &#39;(1920, 1080)&#39;: 185})</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="video-utils">video utils<a class="anchor-link" href="#video-utils"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">decord</span> <span class="kn">import</span> <span class="n">VideoReader</span>
<span class="kn">from</span> <span class="nn">decord</span> <span class="kn">import</span> <span class="n">cpu</span>
<span class="kn">from</span> <span class="nn">decord.bridge</span> <span class="kn">import</span> <span class="n">set_bridge</span>
<span class="n">set_bridge</span><span class="p">(</span><span class="s1">&#39;torch&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_decord_video_batch_cpu</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;get batch tensor for inference, original for cropping and H,W of video&quot;</span>
    <span class="n">video</span> <span class="o">=</span> <span class="n">VideoReader</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">cpu</span><span class="p">())</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">video</span><span class="p">),</span> <span class="n">freq</span><span class="p">))</span>
    <span class="n">H</span><span class="p">,</span><span class="n">W</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">sz</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">sz</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t</span> <span class="o">-=</span> <span class="n">stats</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">convert_bboxes</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">sz</span><span class="p">):</span>
    <span class="s2">&quot;rescale bbox prediction to original image sz&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">bboxes</span><span class="p">:</span>
        <span class="n">h_scale</span><span class="p">,</span> <span class="n">w_scale</span> <span class="o">=</span> <span class="n">H</span><span class="o">/</span><span class="n">sz</span><span class="p">,</span> <span class="n">W</span><span class="o">/</span><span class="n">sz</span>
        <span class="n">orig_bboxes</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb</span><span class="o">*</span><span class="n">array</span><span class="p">([</span><span class="n">w_scale</span><span class="p">,</span> <span class="n">h_scale</span><span class="p">,</span> <span class="n">w_scale</span><span class="p">,</span> <span class="n">h_scale</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orig_bboxes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">rescale_bbox</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">bb_scale</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span><span class="n">W</span><span class="p">):</span>
    <span class="s2">&quot;rescale a bbox: (left, top, right, bottom) with a given scale parameter&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">bb</span>
    
    <span class="n">cx</span><span class="p">,</span><span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> 
    <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span><span class="p">),</span> <span class="p">(</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span>
    <span class="n">sh</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">bb_scale</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">bb_scale</span><span class="p">)</span>

    <span class="n">stop</span><span class="p">,</span> <span class="n">sbottom</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="n">sh</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">sh</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">sleft</span><span class="p">,</span> <span class="n">sright</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">sw</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">sw</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">stop</span><span class="p">,</span> <span class="n">sleft</span><span class="p">,</span> <span class="n">sbottom</span><span class="p">,</span> <span class="n">sright</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sleft</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">sbottom</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">sright</span><span class="p">)</span>    
    <span class="k">return</span> <span class="p">(</span><span class="n">sleft</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">sright</span><span class="p">,</span> <span class="n">sbottom</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="save-cropped-faces">save cropped faces<a class="anchor-link" href="#save-cropped-faces"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># dir to save images for all videos</span>
<span class="n">crop_path</span> <span class="o">=</span> <span class="n">data_path</span><span class="o">/</span><span class="s2">&quot;cropped_faces&quot;</span><span class="o">/</span><span class="n">video_path</span><span class="o">.</span><span class="n">name</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">crop_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">crop_path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>PosixPath(&#39;/home/ubuntu/data/cropped_faces/dfdc_train_part_49&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">video_path</span><span class="o">.</span><span class="n">ls</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[PosixPath(&#39;/home/ubuntu/data/dfdc_train_part_49/yraysfvtgv.mp4&#39;),
 PosixPath(&#39;/home/ubuntu/data/dfdc_train_part_49/jidkzoagws.mp4&#39;),
 PosixPath(&#39;/home/ubuntu/data/dfdc_train_part_49/uowiocuqqt.mp4&#39;)]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span><span class="n">PathOrStr</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="s2">&quot;Save the image to `fn`.&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">image2np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mi">255</span> <span class="k">if</span> <span class="n">mult</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<span class="n">Image</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">save</span> <span class="c1"># monkey patch</span>

<span class="k">def</span> <span class="nf">crop_and_save</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="n">PathOrStr</span><span class="p">,</span> <span class="n">fname</span><span class="p">:</span><span class="n">PathOrStr</span><span class="p">,</span> <span class="n">crop_path</span><span class="p">:</span><span class="n">PathOrStr</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">]],</span>
                  <span class="n">freq</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    path: directory which has the video with fname</span>
<span class="sd">    fname: filename of video &quot;xxxxx.mp4&quot;</span>
<span class="sd">    crop_path: destination directory to save cropped images for video</span>
<span class="sd">    bboxes: list of bbox coordinates for each sampled frame for video</span>
<span class="sd">    freq: sample frequence used in bbox detection</span>
<span class="sd">    total_frames: total number of frames sampled from video during detection    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># read sampled raw video</span>
    <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_decord_video_batch_cpu</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="n">fname</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># create directory to save crops</span>
    <span class="n">video_dir</span> <span class="o">=</span> <span class="n">crop_path</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">video_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># check if # of face detections are same as # of sampled frames</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">frame_no</span><span class="p">,</span> <span class="p">(</span><span class="n">_frame</span><span class="p">,</span> <span class="n">_bb</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">)):</span>
        <span class="c1"># don&#39;t try cropping if no detection is available for the frame</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">_bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="k">except</span><span class="p">:</span> <span class="k">continue</span>
        <span class="c1"># naive: get first bbox, optionally rescale</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span>  <span class="o">=</span> <span class="n">rescale_bbox</span><span class="p">(</span><span class="n">_bb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.3</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> 
        <span class="c1"># crop and save</span>
        <span class="n">face_crop</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">_frame</span><span class="p">[:,</span> <span class="n">top</span><span class="p">:</span><span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">])</span>
        <span class="c1"># save with frame index (start from 1) and sequence length (total available frames)</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">video_dir</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;frame_{frame_no+1}_</span><span class="si">{total_frames}</span><span class="s2">.jpg&quot;</span>
        <span class="n">face_crop</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">face_detections_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
    <span class="n">face_detections</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;face_detections&#39;</span><span class="p">]</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;detections&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">face_detections</span><span class="p">]</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sample_freq&#39;</span><span class="p">]</span>
    <span class="n">total_frames</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;n_frames&#39;</span><span class="p">]</span>
    <span class="n">crop_and_save</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">crop_path</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>3134it [37:16,  1.40it/s]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}
</div>
 

